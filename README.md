# AI SRE Agent

An AI-powered Site Reliability Engineering agent that monitors your server, analyzes issues using Claude Code, and executes fixes only after human approval.

## Features

- **Plan-First Approach**: Never executes changes without your approval
- **Claude Code Integration**: Uses your existing Claude Code CLI for intelligent analysis
- **Multi-Channel Notifications**: Mobile push, email, and TTS alerts
- **Safe Execution**: Rate limiting, protected containers, safety checks
- **Comprehensive Monitoring**: Docker, system metrics, logs, services

## Quick Start

```bash
# 1. Configure environment
cp .env.example .env
# Edit .env and add your HA_TOKEN

# 2. Test in dry-run mode
python3 agent.py run --dry-run

# 3. Install as service
sudo ./install.sh

# 4. Enable the service
sudo systemctl enable --now ai-sre-agent.service
```

## Usage

### Check Status
```bash
# Run a single check
python3 agent.py run

# Run as daemon
python3 agent.py daemon

# List pending plans
python3 agent.py list

# List all plans (including history)
python3 agent.py list --status all
```

### Manage Plans
```bash
# Approve a plan
python3 agent.py approve 20260108_143022

# Reject a plan
python3 agent.py reject 20260108_143022 --reason "Not needed"
```

## Configuration

Edit `config/config.yaml` to customize:

- `agent.check_interval`: How often to run checks (default: 300s)
- `agent.dry_run`: Set to `false` to enable execution
- `collectors.*`: Enable/disable specific collectors
- `notifications.*`: Configure notification channels
- `safety.*`: Set protected containers and rate limits

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     AI SRE Agent Service                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  Collectors  │  │   Analyzer   │  │    Action Engine     │   │
│  │              │  │              │  │                      │   │
│  │ • Docker     │  │ • Claude CLI │  │ • Wait for approval  │   │
│  │ • System     │→ │ • Playbooks  │→ │ • Execute plan       │   │
│  │ • Logs       │  │ • Confidence │  │ • Report results     │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Notification Layer                    │    │
│  │  • Email (SMTP)  • Mobile Push (HA)  • TTS (HA)         │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## Plan Schema

Plans generated by Claude follow this schema:

```json
{
  "plan_schema_version": "1.0",
  "summary": "Container nocodb unhealthy for 5 minutes",
  "severity": "warning",
  "confidence": 0.8,
  "root_cause": "Container health check failing",
  "evidence": ["docker ps shows nocodb (unhealthy)"],
  "risk": "low",
  "requires_approval": true,
  "plan": [
    {
      "step": 1,
      "action": "Restart container",
      "command": "docker restart nocodb",
      "timeout_seconds": 60,
      "reversible": true
    }
  ],
  "postchecks": ["docker ps --filter name=nocodb"],
  "rollback": ["No rollback needed - restart is self-correcting"]
}
```

## Safety Features

1. **Dry-run mode**: Enabled by default
2. **Rate limiting**: Max 3 fixes per hour
3. **Protected containers**: homeassistant, mosquitto, postgres, authelia
4. **Dangerous command detection**: Blocks destructive patterns
5. **Human approval required**: Every plan needs explicit approval

## Files

```
ai-sre-agent/
├── agent.py              # Main orchestrator
├── collectors/
│   ├── docker.py         # Container health & logs
│   ├── system.py         # Disk, CPU, memory, services
│   └── logs.py           # Journal and log file errors
├── analyzer/
│   └── claude.py         # Claude Code CLI integration
├── actions/
│   ├── notify.py         # Email, push, TTS notifications
│   └── execute.py        # Safe command execution
├── config/
│   ├── config.yaml       # Main configuration
│   └── playbooks.yaml    # Fallback rules
├── data/
│   ├── plans/            # Pending plans
│   └── history/          # Completed/rejected plans
└── install.sh            # Systemd installation
```

## Logs

- Service log: `/var/log/ai-sre-agent.log`
- Systemd: `journalctl -u ai-sre-agent -f`
- Plan history: `data/history/`
